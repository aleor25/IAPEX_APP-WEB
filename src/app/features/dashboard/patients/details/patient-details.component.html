<div class="bg-light-subtle p-4 rounded-4 border">
  <form class="mb-0" [formGroup]="patientForm">
    <h5 class="mb-4">Información de registro</h5>

    <div class="row mb-3">
      <div class="col">
        <label for="registrationDateTime" class="form-label">Fecha y hora de registro</label>
        <input type="text" class="form-control" id="registrationDateTime" formControlName="registrationDateTime"
          placeholder="Ingrese la fecha y hora de registro" readonly
          [class.is-invalid]="patientForm.get('registrationDateTime')?.invalid && (patientForm.get('registrationDateTime')?.dirty || patientForm.get('registrationDateTime')?.touched)">
      </div>

      <div class="col">
        <label for="registeringUser" class="form-label">Usuario que lo registro</label>
        <input type="text" class="form-control" id="registeringUser" formControlName="registeringUser"
          placeholder="Ingrese el usuario que lo registro" readonly
          [class.is-invalid]="patientForm.get('registeringUser')?.invalid && (patientForm.get('registeringUser')?.dirty || patientForm.get('registeringUser')?.touched)">
      </div>

      <div class="col">
        <label for="active" class="form-label">Estado</label>
        <select type="text" class="form-select" id="active" formControlName="active"
          [class.bg-body-tertiary]="!patientForm.get('active')?.disabled"
          [class.is-invalid]="patientForm.get('active')?.invalid && (patientForm.get('active')?.dirty || patientForm.get('active')?.touched)">
          <option value="true">No encontrado</option>
          <option value="false">Encontrado</option>
        </select>
        @if (patientForm.get('active')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El estado del paciente es requerido.
        </p>
        }
      </div>
    </div>

    <h5 class="my-4">Información personal</h5>

    <div class="row mb-3">
      <div class="col">
        <label for="name" class="form-label">Nombre</label>
        <input type="text" class="form-control bg-body-tertiary" id="name" formControlName="name"
          placeholder="Ingrese el nombre del paciente"
          [class.is-invalid]="patientForm.get('name')?.invalid && (patientForm.get('name')?.dirty || patientForm.get('name')?.touched)">
        @if (patientForm.get('name')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El nombre no puede exceder los 50 caracteres.
        </p>
        }
        @if (patientForm.get('name')?.errors?.['pattern']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El nombre solo puede contener letras.
        </p>
        }
      </div>

      <div class="col">
        <label for="lastName" class="form-label">Apellido paterno</label>
        <input type="text" class="form-control bg-body-tertiary" id="lastName" formControlName="lastName"
          placeholder="Ingrese el apellido paterno"
          [class.is-invalid]="patientForm.get('lastName')?.invalid && (patientForm.get('lastName')?.dirty || patientForm.get('lastName')?.touched)">
        @if (patientForm.get('lastName')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El apellido paterno no puede exceder los 50 caracteres.
        </p>
        }
        @if (patientForm.get('lastName')?.errors?.['pattern']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El apellido paterno solo puede contener letras.
        </p>
        }
      </div>

      <div class="col">
        <label for="secondLastName" class="form-label">Apellido materno</label>
        <input type="text" class="form-control bg-body-tertiary" id="secondLastName" formControlName="secondLastName"
          placeholder="Ingrese el apellido materno"
          [class.is-invalid]="patientForm.get('secondLastName')?.invalid && (patientForm.get('secondLastName')?.dirty || patientForm.get('secondLastName')?.touched)">
        @if (patientForm.get('secondLastName')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El apellido materno no puede exceder los 50 caracteres.
        </p>
        }
        @if (patientForm.get('secondLastName')?.errors?.['pattern']) {
        <p class="small text danger mt-2">
          El apellido materno solo puede contener letras.
        </p>
        }
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-4">
        <label for="gender" class="form-label">Sexo*</label>
        <select id="gender" class="form-select bg-body-tertiary" formControlName="gender"
          [class.is-invalid]="patientForm.get('gender')?.invalid && (patientForm.get('gender')?.dirty || patientForm.get('gender')?.touched)">
          <option value="" selected>Seleccione el sexo</option>
          <option value="masculino">Masculino</option>
          <option value="femenino">Femenino</option>
        </select>
        @if (patientForm.get('gender')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El sexo del paciente es requerido.
        </p>
        }
      </div>

      <div class="col-4">
        <label for="approximateAge" class="form-label">Edad aparente*</label>
        <input class="form-control bg-body-tertiary" id="approximateAge" formControlName="approximateAge"
          placeholder="Ingrese la edad del paciente" maxlength="3"
          [class.is-invalid]="patientForm.get('approximateAge')?.invalid && (patientForm.get('approximateAge')?.dirty || patientForm.get('approximateAge')?.touched)">
        @if (patientForm.get('approximateAge')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La edad del paciente es requerida.
        </p>
        }
        @if (patientForm.get('approximateAge')?.errors?.['pattern']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La edad debe ser un número entero.
        </p>
        }
        @if (patientForm.get('approximateAge')?.errors?.['max']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La edad no puede ser mayor a 150 años.
        </p>
        }
        @if (patientForm.get('approximateAge')?.errors?.['min']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La edad no puede ser menor a 0 años.
        </p>
        }
      </div>
    </div>


    <div class="row mb-3">
      <h5 class="my-4">Información morfológica</h5>

      <div class="col">
        <label for="skinColor" class="form-label">Color de piel*</label>
        <select id="skinColor" class="form-select bg-body-tertiary" formControlName="skinColor"
          [class.is-invalid]="patientForm.get('skinColor')?.invalid && (patientForm.get('skinColor')?.dirty || patientForm.get('skinColor')?.touched)">
          <option value="" selected>Seleccione un color de piel</option>
          <option value="clara">Clara</option>
          <option value="morena">Morena</option>
          <option value="oscura">Oscura</option>
        </select>
        @if (patientForm.get('skinColor')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El color de piel del paciente es requerido.
        </p>
        }
      </div>

      <div class="col">
        <label for="eyeColor" class="form-label">Color de ojos*</label>
        <select id="eyeColor" class="form-select bg-body-tertiary" formControlName="eyeColor"
          [class.is-invalid]="patientForm.get('eyeColor')?.invalid && (patientForm.get('eyeColor')?.dirty || patientForm.get('eyeColor')?.touched)">
          <option value="" selected>Seleccione un color de ojos</option>
          <option value="café">Café</option>
          <option value="azul">Azul</option>
          <option value="verde">Verde</option>
          <option value="gris">Gris</option>
          <option value="avellana">Avellana</option>
          <option value="ambar">Ámbar</option>
          <option value="heterocromía">Heterocromía</option>
        </select>
        @if (patientForm.get('eyeColor')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El color de ojos del paciente es requerido.
        </p>
        }
      </div>

      <div class="col">
        <label for="approximateHeight" class="form-label">Altura aproximada (cm)*</label>
        <input class="form-control bg-body-tertiary" id="approximateHeight" formControlName="approximateHeight"
          placeholder="Ingrese la altura aproximada" maxlength="3"
          [class.is-invalid]="patientForm.get('approximateHeight')?.invalid && (patientForm.get('approximateHeight')?.dirty || patientForm.get('approximateHeight')?.touched)">
        @if (patientForm.get('approximateHeight')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La altura del paciente es requerida.
        </p>
        }
        @if (patientForm.get('approximateHeight')?.errors?.['min']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La altura no puede ser menor a 50 cm.
        </p>
        }
        @if (patientForm.get('approximateHeight')?.errors?.['max']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La altura no puede ser mayor a 300 cm.
        </p>
        }
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label for="hairLength" class="form-label">Largo del cabello*</label>
        <select id="hairLength" class="form-select bg-body-tertiary" formControlName="hairLength"
          [class.is-invalid]="patientForm.get('hairLength')?.invalid && (patientForm.get('hairLength')?.dirty || patientForm.get('hairLength')?.touched)">
          <option value="" selected>Seleccione el largo del cabello</option>
          <option value="calvo">Calvo</option>
          <option value="corto">Corto</option>
          <option value="medio">Medio</option>
          <option value="largo">Largo</option>
        </select>
        @if (patientForm.get('hairLength')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El largo de cabello del paciente es requerido.
        </p>
        }
      </div>

      @if (patientForm.get('hairLength')?.value != 'calvo') {
      <div class="col">
        <label for="hairType" class="form-label">Tipo de cabello*</label>
        <select id="hairType" class="form-select bg-body-tertiary" formControlName="hairType"
          [class.is-invalid]="patientForm.get('hairType')?.invalid && (patientForm.get('hairType')?.dirty || patientForm.get('hairType')?.touched)">
          <option value="" selected>Seleccione un tipo de cabello</option>
          <option value="liso">Liso</option>
          <option value="ondulado">Ondulado</option>
          <option value="rizado">Rizado</option>
          <option value="crespo">Crespo</option>
        </select>
        @if (patientForm.get('hairType')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El tipo de cabello del paciente es requerido.
        </p>
        }
      </div>

      <div class="col">
        <label for="hairColor" class="form-label">Color de cabello*</label>
        <select id="hairColor" class="form-select bg-body-tertiary" formControlName="hairColor"
          [class.is-invalid]="patientForm.get('hairColor')?.invalid && (patientForm.get('hairColor')?.dirty || patientForm.get('hairColor')?.touched)">
          <option value="" selected>Seleccione un color de cabello</option>
          <option value="negro">Negro</option>
          <option value="castaño">Castaño</option>
          <option value="rubio">Rubio</option>
          <option value="pelirrojo">Pelirrojo</option>
          <option value="canoso">Canoso</option>
          <option value="otro">Otro</option>
        </select>
        @if (patientForm.get('hairColor')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El color de cabello del paciente es requerido.
        </p>
        }

        <!-- Campo adicional para el color personalizado -->
        @if (patientForm.get('hairColor')?.value === 'otro') {
        <div class="col mt-3">
          <input id="customHairColor" type="text" class="form-control bg-body-tertiary"
            formControlName="customHairColor" placeholder="Especifique el color de cabello"
            [class.is-invalid]="patientForm.get('customHairColor')?.invalid && (patientForm.get('customHairColor')?.dirty || patientForm.get('customHairColor')?.touched)">
          @if (patientForm.get('customHairColor')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            Especifique el color de cabello.
          </p>
          }
          @if (patientForm.get('customHairColor')?.errors?.['maxlength']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El color de cabello no debe superar los 50 caracteres.
          </p>
          }
          @if (patientForm.get('customHairColor')?.errors?.['pattern']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El color de cabello solo puede contener letras.
          </p>
          }
        </div>
        }
      </div>
      }
    </div>

    <div class="row mb-3">
      <div class="col-4">
        <label for="complexion" class="form-label">Complexión*</label>
        <select id="complexion" class="form-select bg-body-tertiary" formControlName="complexion"
          [class.is-invalid]="patientForm.get('complexion')?.invalid && (patientForm.get('complexion')?.dirty || patientForm.get('complexion')?.touched)">
          <option value="" selected>Seleccione la complexión</option>
          <option value="delgada">Delgada</option>
          <option value="media">Media</option>
          <option value="robusta">Robusta</option>
          <option value="sobrepeso">Sobrepeso</option>
        </select>
        @if (patientForm.get('complexion')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La complexión del paciente es requerida.
        </p>
        }
      </div>
    </div>

    <h5 class="my-4">Información adicional</h5>

    <div class="row mb-3">
      <div class="col-6">
        <label for="medicalConditions" class="form-label">Condiciones médicas</label>
        <textarea type="text" class="form-control bg-body-tertiary" id="medicalConditions"
          formControlName="medicalConditions" placeholder="Ingrese las condiciones médicas del paciente"></textarea>
        @if (patientForm.get('medicalConditions')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          Las condiciones médicas no pueden ser mayor a 255 caracteres.
        </p>
        }
      </div>

      <div class="col-6">
        <label for="distinctiveFeatures" class="form-label">Señas particulares</label>
        <textarea type="text" class="form-control bg-body-tertiary" id="distinctiveFeatures"
          formControlName="distinctiveFeatures" placeholder="Ingrese las señas particulares del paciente"></textarea>
        @if (patientForm.get('distinctiveFeatures')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          Las señas particulares no pueden ser mayor a 255 caracteres.
        </p>
        }
      </div>
    </div>

    <div class="d-flex align-items-center my-4">
      <h5 class="form-label my-0 me-2">Imágenes del paciente*</h5>
      <div class="dropdown dropdown-hover d-flex align-items-center">
        <i class="bi bi-info-circle" [class.text-danger]="imageUploadError.length > 0" style="cursor: pointer;"></i>
        <div class="dropdown-menu p-3">
          <p class="m-1 border-bottom">
            Debe subir entre 3 y 6 imágenes.
          </p>
          <p class="m-1 border-bottom">
            Formatos admitidos: JPG, JPEG, PNG, BMP, WEBP, TIFF, HEIF.
          </p>
          <p class="m-1 border-bottom">
            El tamaño máximo por imagen es de 5 MB.
          </p>
          <p class="m-1 border-bottom">
            Usa imágenes claras del rostro y desde diferentes ángulos.
          </p>
          <p class="m-1 border-bottom">
            Resolución máxima permitida: 4080x4080 píxeles.
          </p>
        </div>
      </div>
    </div>

    <input class="form-control bg-body-tertiary d-none" type="file" id="patientImages"
      (change)="onFilesSelected($event)" multiple>

    <!-- Sección de carga de fotos -->
    @if (tempImages.length < 6) { <div
      class="upload-area bg-body-tertiary border-secondary-subtle border-2 rounded p-4 d-flex flex-column align-items-center justify-content-center text-center"
      [class.border-danger-subtle]="imageUploadError.length > 0" (drop)="handleDrop($event)"
      (dragover)="handleDragOver($event)" (click)="triggerFileInput()">

      <!-- Icono y mensaje de arrastrar y soltar -->
      <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-2"></i>
      <p class="mb-2">Arrastre sus fotos aquí o</p>
      <button class="btn btn-primary">Seleccione archivos</button>

      <!-- Mensaje de error si hay problemas de subida -->
      @if (imageUploadError.length > 0) {
      @for (error of imageUploadError; track $index) {
      <p class="small text-danger mt-2 mb-0">{{ error.error }}</p>
      }
      }
</div>
}

<!-- Vista previa de las imágenes cargadas -->
@if (tempImages.length > 0) {
<div class="row row-cols-3 g-2 mt-3">
  @for (preview of tempImages; track $index) {
  <div class="col">
    <div class="position-relative image-container border rounded-4">
      <img [src]="preview" alt="Vista previa de la imagen">

      <!-- Icono de eliminación dentro de un círculo blanco -->
      <button (click)="removeImage($index)" title="Eliminar imagen"
        class="btn btn-sm btn-link position-absolute top-0 start-0 m-2 bg-light-subtle rounded-circle">
        <i class="bi bi-trash text-danger"></i>
      </button>
    </div>
  </div>
  }
</div>
}

<!-- Botón de envío y mensaje de error -->
<div class="d-flex justify-content-end align-items-end mt-4 gap-2">
  <button type="submit" class="btn btn-primary" (click)="updatePatient()"
    [disabled]="!isFormModified || loading">Actualizar paciente</button>

  <button type="submit" class="btn btn-danger" (click)="openDeleteModal()">Eliminar
    paciente</button>
</div>
<!-- Mostrar mensaje de error -->
<div class="d-flex flex-column align-items-end">
  @if (errorMessage) {
  <p class="small text-danger mt-2 mb-0">
    {{ errorMessage }}
  </p>
  }
</div>
</form>
</div>

<!-- Modal -->
<app-modal [title]="'¿Está seguro de eliminar el registro de este paciente?'"
  [message]="'Esta acción no se puede deshacer.'"
  (confirmed)="deletePatient(patient.id)">
</app-modal>