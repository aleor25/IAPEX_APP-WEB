<div class="bg-light-subtle p-4 rounded-4 border">
  <h5 class="mb-4">Información principal</h5>

  <form class="mb-0" [formGroup]="institutionForm" (ngSubmit)="addInstitution()">
    <div class="row mb-3">
      <div class="col">
        <label for="name" class="form-label">Nombre de la institución*</label>
        <input type="text" class="form-control bg-body-tertiary" id="name" formControlName="name"
          placeholder="Ingresa el nombre de la institución"
          [class.is-invalid]="institutionForm.get('name')?.invalid && (institutionForm.get('name')?.dirty || institutionForm.get('name')?.touched)">
        @if (institutionForm.get('name')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El nombre de la institución es requerido.
        </p>
        }
        @if (institutionForm.get('name')?.errors?.['maxlength']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El nombre no puede exceder los 50 caracteres.
        </p>
        }
      </div>

      <div class="col">
        <label for="type" class="form-label">Tipo de institución*</label>
        <select class="form-select bg-body-tertiary" id="type" formControlName="type"
          [class.is-invalid]="institutionForm.get('type')?.invalid && (institutionForm.get('type')?.dirty || institutionForm.get('type')?.touched)">
          <option value="">Seleccione un tipo de institución</option>
          <option value="hospital">Hospital</option>
          <option value="clínica">Clínica</option>
          <option value="centro médico">Centro Médico</option>
          <option value="consultorio">Consultorio</option>
          <option value="otro">Otro</option>
        </select>
        @if (institutionForm.get('type')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El tipo de institución es requerido.
        </p>
        }

        <!-- Campo adicional solo visible si se selecciona 'Otro' -->
        <div *ngIf="institutionForm.get('type')?.value === 'otro'" class="mt-3">
          <label for="otherType" class="form-label">Especificar tipo</label>
          <input type="text" class="form-control bg-body-tertiary" id="otherType" formControlName="otherType"
            placeholder="Especifica el tipo de institución"
            [class.is-invalid]="institutionForm.get('otherType')?.invalid && (institutionForm.get('otherType')?.dirty || institutionForm.get('otherType')?.touched)">
          @if (institutionForm.get('otherType')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El tipo especificado es requerido.
          </p>
          }
          @if (institutionForm.get('otherType')?.errors?.['maxlength']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El tipo no puede exceder los 50 caracteres.
          </p>
          }
        </div>
      </div>

      <div class="col">
        <label for="verificationKey" class="form-label">Clave de verificación*</label>
        <input type="text" class="form-control bg-body-tertiary" id="verificationKey"
          placeholder="Ingresa la clave de verificación" formControlName="verificationKey"
          [class.is-invalid]="institutionForm.get('verificationKey')?.invalid && (institutionForm.get('verificationKey')?.dirty || institutionForm.get('verificationKey')?.touched)">
        @if (institutionForm.get('verificationKey')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          La clave de verificación es requerida.
        </p>
        }
      </div>
    </div>

    <h5 class="my-4">Información de ubicación</h5>

    <div class="mb-4" formGroupName="direction">
      <div class="row mb-3">
        <div class="col">
          <label for="state" class="form-label">Estado*</label>
          <input type="text" class="form-control bg-body-tertiary" id="state" formControlName="state"
            placeholder="Ingresa el estado"
            [class.is-invalid]="institutionForm.get('direction.state')?.invalid && (institutionForm.get('direction.state')?.dirty || institutionForm.get('direction.state')?.touched)">
          @if (institutionForm.get('direction.state')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El estado es requerido.
          </p>
          }
        </div>

        <div class="col">
          <label for="city" class="form-label">Ciudad*</label>
          <input type="text" class="form-control bg-body-tertiary" id="city" formControlName="city"
            placeholder="Ingresa la ciudad"
            [class.is-invalid]="institutionForm.get('direction.city')?.invalid && (institutionForm.get('direction.city')?.dirty || institutionForm.get('direction.city')?.touched)">
          @if (institutionForm.get('direction.city')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            La ciudad es requerida.
          </p>
          }
        </div>

        <div class="col">
          <label for="postalCode" class="form-label">Código postal*</label>
          <input type="text" class="form-control bg-body-tertiary" id="postalCode" formControlName="postalCode"
            placeholder="Ingresa el código postal"
            [class.is-invalid]="institutionForm.get('direction.postalCode')?.invalid && (institutionForm.get('direction.postalCode')?.dirty || institutionForm.get('direction.postalCode')?.touched)">
          @if (institutionForm.get('direction.postalCode')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El código postal es requerido.
          </p>
          }
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-4">
          <label for="street" class="form-label">Calle*</label>
          <input type="text" class="form-control bg-body-tertiary" id="street" formControlName="street"
            placeholder="Ingresa la calle"
            [class.is-invalid]="institutionForm.get('direction.street')?.invalid && (institutionForm.get('direction.street')?.dirty || institutionForm.get('direction.street')?.touched)">
          @if (institutionForm.get('direction.street')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            La calle es requerida.
          </p>
          }
        </div>

        <div class="col-4">
          <label for="number" class="form-label">Número*</label>
          <input type="text" class="form-control bg-body-tertiary" id="number" formControlName="number"
            placeholder="Ingresa el número"
            [class.is-invalid]="institutionForm.get('direction.number')?.invalid && (institutionForm.get('direction.number')?.dirty || institutionForm.get('direction.number')?.touched)">
          @if (institutionForm.get('direction.number')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            El número es requerido.
          </p>
          }
        </div>

        <div class="col">
          <label for="neighborhood" class="form-label">Colonia*</label>
          <input type="text" class="form-control bg-body-tertiary" id="neighborhood" formControlName="neighborhood"
            placeholder="Ingresa la colonia"
            [class.is-invalid]="institutionForm.get('direction.neighborhood')?.invalid && (institutionForm.get('direction.neighborhood')?.dirty || institutionForm.get('direction.neighborhood')?.touched)">
          @if (institutionForm.get('direction.neighborhood')?.errors?.['required']) {
          <p class="small invalid-feedback mt-2 mb-0">
            La colonia es requerida.
          </p>
          }
        </div>
      </div>
    </div>

    <h5 class="my-4">Información de contacto</h5>

    <div class="row mb-3">
      <div class="col">
        <label for="openingHours" class="form-label">Horario de atención*</label>
        <input type="text" class="form-control bg-body-tertiary" id="openingHours" formControlName="openingHours"
          placeholder="Ej: Lunes a Viernes 9:00 - 18:00"
          [class.is-invalid]="institutionForm.get('openingHours')?.invalid && (institutionForm.get('openingHours')?.dirty || institutionForm.get('openingHours')?.touched)">
        @if (institutionForm.get('openingHours')?.errors?.['required']) {
        <p class="small invalid-feedback mt-2 mb-0">
          El horario de atención es requerido
        </p>
        }
      </div>

      <div class="col">
        <label for="emails" class="form-label">Correos electrónicos</label>
        <div class="input-group mb-3">
          <input type="text" class="form-control bg-body-tertiary" id="emails" formControlName="emails"
            placeholder="Separa múltiples correos con comas"
            [class.is-invalid]="institutionForm.get('emails')?.invalid && (institutionForm.get('emails')?.dirty || institutionForm.get('emails')?.touched)">
          <button class="btn btn-outline-secondary" type="button"><i class="bi bi-plus"></i></button>
          @if (institutionForm.get('emails')?.errors?.['pattern']) {
          <p class="small invalid-feedback mt-2 mb-0">
            Los correos electrónicos no son validos.
          </p>
          }
        </div>
      </div>

      <div class="col">
        <label for="phoneNumbers" class="form-label">Números telefónicos</label>
        <div class="input-group mb-3">
          <input type="text" class="form-control bg-body-tertiary" id="phoneNumbers" formControlName="phoneNumbers"
            placeholder="Separa múltiples números con comas" maxlength="10" minlength="10"
            [class.is-invalid]="institutionForm.get('phoneNumbers')?.invalid && (institutionForm.get('phoneNumbers')?.dirty || institutionForm.get('phoneNumbers')?.touched)">
          <button class="btn btn-outline-secondary" type="button"><i class="bi bi-plus"></i></button>
          @if (institutionForm.get('phoneNumbers')?.errors?.['maxlength']) {
          <p class="small invalid-feedback mt-2 mb-0">
            Los números telefónicos no pueden exceder los 10 caracteres.
          </p>
          }
          @if (institutionForm.get('phoneNumbers')?.errors?.['minlength']) {
          <p class="small invalid-feedback mt-2 mb-0">
            Los números telefónicos deben tener al menos 10 caracteres.
          </p>
          }
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-4">
        <label for="websites" class="form-label">Sitios web</label>
        <input type="text" class="form-control bg-body-tertiary" id="websites" formControlName="websites"
          placeholder="Separa múltiples sitios web con comas"
          [class.is-invalid]="institutionForm.get('websites')?.invalid && (institutionForm.get('websites')?.dirty || institutionForm.get('websites')?.touched)">
        <!-- @if (institutionForm.get('websites')?.errors?.['']) {
        <p class="small invalid-feedback mt-2 mb-0">
        </p>
        } -->
      </div>

      <div class="col-4">
        <label for="mapUrl" class="form-label">URL de Google Maps</label>
        <input type="text" class="form-control bg-body-tertiary" id="mapUrl" formControlName="mapUrl"
          placeholder="Ej: https://maps.google.com/..."
          [class.is-invalid]="institutionForm.get('mapUrl')?.invalid && (institutionForm.get('mapUrl')?.dirty || institutionForm.get('mapUrl')?.touched)">
        <!-- @if (institutionForm.get('mapUrl')?.errors?.['']) {
        <p class="small invalid-feedback mt-2 mb-0">
        </p>
        } -->
      </div>
    </div>

    <div class="d-flex align-items-center my-4">
      <h5 class="form-label my-0 me-2">Imagen de la institución*</h5>
      <div class="dropdown dropdown-hover d-flex align-items-center">
        <i class="bi bi-info-circle" [class.text-danger]="imageUploadError.length > 0" style="cursor: pointer;"></i>
        <div class="dropdown-menu p-3">
          <p class="m-1 border-bottom">
            Debes subir unicamente una imagen.
          </p>
          <p class="m-1 border-bottom">
            Formatos admitidos: JPG, JPEG, PNG, BMP, WEBP, TIFF, HEIF.
          </p>
          <p class="m-1 border-bottom">
            El tamaño máximo de la imagen es de 5 MB.
          </p>
          <p class="m-1 border-bottom">
            Resolución máxima permitida: 4080x4080 píxeles.
          </p>
        </div>
      </div>
    </div>

    <input class="form-control bg-body-tertiary bg-body-tertiary d-none" type="file" id="institutionImage"
      (change)="onFilesSelected($event)" multiple>

    <!-- Sección de carga de fotos -->
    <div
      class="upload-area bg-body-tertiary border-secondary-subtle border-2 rounded p-4 d-flex flex-column align-items-center justify-content-center text-center"
      [class.border-danger-subtle]="imageUploadError.length > 0" (drop)="handleDrop($event)"
      (dragover)="handleDragOver($event)" (click)="triggerFileInput()">

      <!-- Icono y mensaje de arrastrar y soltar -->
      <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-2"></i>
      <p class="mb-2">Arrastra tus fotos aquí o</p>
      <button class="btn btn-primary">Selecciona archivos</button>

      <!-- Mensaje de error si hay problemas de subida -->
      @if (imageUploadError.length > 0) {
      @for (error of imageUploadError; track $index) {
      <p class="small text-danger mt-2 mb-0">{{ error.error }}</p>
      }
      }
    </div>


    <!-- Vista previa de las imágenes cargadas -->
    @if (tempImages.length > 0) {
    <div class="row row-cols-3 g-2 mt-3">
      @for (preview of tempImages; track $index) {
      <div class="col">
        <div class="position-relative image-container border rounded-4">
          <img [src]="preview" alt="Vista previa de la imagen">

          <!-- Icono de eliminación dentro de un círculo blanco -->
          <button (click)="removeImage($index)" title="Eliminar imagen"
            class="btn btn-sm btn-link position-absolute top-0 start-0 m-2 p-1 bg-light-subtle rounded-circle">
            <i class="bi bi-trash text-danger"></i>
          </button>
        </div>
      </div>
      }
    </div>
    }

    <!-- Botón de envío y mensaje de error -->
    <div class="d-flex flex-column align-items-end">
      <button type="submit" class="btn btn-primary mt-4" [disabled]="loading">
        Registrar institución
      </button>

      <!-- Mostrar mensaje de error -->
      @if (errorMessage) {
      <p class="small text-danger mt-2 mb-0">
        {{ errorMessage }}
      </p>
      }
    </div>
  </form>
</div>